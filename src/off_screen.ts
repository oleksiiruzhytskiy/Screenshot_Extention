// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
import { log } from "./utils/logger";
import { captureScreen, screenshotCaptured } from "./variable_messages/variable";

// –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
chrome.runtime.onMessage.addListener(async (message, sender, sendResponse) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ "captureScreen" ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞
  if (message.action === captureScreen) {
    log("‚ö° –ù–∞—á–∏–Ω–∞–µ–º –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞...");

    try {
      log("üîç –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º...");
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Ä–∞–Ω—É —á–µ—Ä–µ–∑ getDisplayMedia API
      const stream = await navigator.mediaDevices
        .getDisplayMedia({
          video: true, // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫
        })
        .then((stream) => {
          log("‚úÖ –ü–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω inside THEN:", stream); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
          log(
            "üì∫ –¢–∏–ø —ç–∫—Ä–∞–Ω–∞:",
            stream.getVideoTracks()[0].getSettings().displaySurface // –õ–æ–≥–∏—Ä—É–µ–º —Ç–∏–ø —ç–∫—Ä–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–ª–∏ –æ–∫–Ω–æ)
          );
          return stream; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–æ–∫
        })
        .catch((err) => log("‚ùå –û—à–∏–±–∫–∞:", err)); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏

      log("–ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫:", stream); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—Ç–æ–∫

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ—Ç–æ–∫ –±—ã–ª –ø–æ–ª—É—á–µ–Ω
      if (!stream) {
        log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Ç–æ–∫.");
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–∏–¥–µ–æ—Ç—Ä–µ–∫ –∏–∑ –ø–æ—Ç–æ–∫–∞
      const track = stream.getVideoTracks()[0];
      log("üìπ –ü–æ–ª—É—á–µ–Ω –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫:", track); // –õ–æ–≥–∏—Ä—É–µ–º –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫
      // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d"); // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
      if (!ctx) {
        log("‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ canvas.");
        return;
      }

      // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç video –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
      const videoElement = document.createElement("video");
      videoElement.srcObject = stream; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ –∫–∞–∫ –ø–æ—Ç–æ–∫
      videoElement.play(); // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

      // –ö–æ–≥–¥–∞ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö, –¥–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç
      videoElement.onloadeddata = () => {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas —Ä–∞–≤–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º –≤–∏–¥–µ–æ
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;

        // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≤–∏–¥–µ–æ –Ω–∞ canvas
        ctx.drawImage(videoElement, 0, 0);

        log("üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω!");

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º canvas –≤ data URL (—Å–∫—Ä–∏–Ω—à–æ—Ç) –≤ —Ñ–æ—Ä–º–∞—Ç–µ JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 70%
        const dataUrl = canvas.toDataURL("image/jpeg", 0.7);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
        chrome.runtime.sendMessage({
          action: screenshotCaptured,
          dataUrl: dataUrl,
        });
        log("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.");

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫ —á–µ—Ä–µ–∑ 500 –º—Å, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        setTimeout(() => {
          track.stop();
        }, 500);
        log("üõë –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫.");
      };
    } catch (error) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞
      log("‚ùå –û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞:", log);
    }
  }
});
