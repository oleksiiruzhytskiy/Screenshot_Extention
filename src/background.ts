// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ —É—Ç–∏–ª–∏—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Å–æ–ª—å.
import { log } from "./utils/logger";
import { captureError, captureScreen } from "./variable_messages/variable";

// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
// –ö–æ–≥–¥–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ.
chrome.runtime.onInstalled.addListener(() => {
  log('–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ "–°–∫—Ä–∏–Ω—à–æ—Ç–µ—Ä" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!'); // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ.
});

// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–µ–≤–∏–¥–∏–º–æ–π –≤–∫–ª–∞–¥–∫–∏).
async function ensureOffscreenDocument() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã off_screen.html –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
    const offscreenUrl = chrome.runtime.getURL("off_screen.html");
    log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º offscreen URL:", offscreenUrl); // –õ–æ–≥–∏—Ä—É–µ–º URL –¥–ª—è offscreen –¥–æ–∫—É–º–µ–Ω—Ç–∞.

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã.
    const contexts = await chrome.runtime
      .getContexts({
        contextTypes: [chrome.runtime.ContextType.OFFSCREEN_DOCUMENT], // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ OFFSCREEN_DOCUMENT.
      })
      .then((contexts) => contexts || []); // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.

    // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω offscreen-–¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
    if (contexts.length > 0) {
      log("‚úÖ Offscreen document —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.");
      chrome.runtime.sendMessage({ action: captureScreen }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞.
      return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
    }

    // –ï—Å–ª–∏ offscreen-–¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π.
    log("‚ö° –°–æ–∑–¥–∞—ë–º offscreen –¥–æ–∫—É–º–µ–Ω—Ç...");
    await chrome.offscreen.createDocument({
      url: offscreenUrl, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –¥–ª—è offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞.
      reasons: [chrome.offscreen.Reason.DISPLAY_MEDIA], // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É —Å–æ–∑–¥–∞–Ω–∏—è: –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞.
      justification: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞.", // –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    });

    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞.
    log("‚úÖ Offscreen document —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");

    // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞.
    chrome.runtime.sendMessage({ action: captureError });
  } catch (error) {
    // –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É.
    log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞:", error);
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
chrome.runtime.onMessage.addListener((message) => {
  // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ "requestCapture", –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞.
  if (message.action === "requestCapture") {
    log("üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", message); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    ensureOffscreenDocument(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è offscreen-–¥–æ–∫—É–º–µ–Ω—Ç–∞.
  } else if (message.action === captureError) {
    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫—É –∑–∞—Ö–≤–∞—Ç–∞, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É.
    log("‚ùå –û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞:", message.error);
  }
});
